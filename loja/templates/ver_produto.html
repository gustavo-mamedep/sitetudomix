{% extends 'base.html' %}
{% load static %}

{% block body %}

<main class="principal principal--padding-b principal--gap">
  <section class="s-produto">
    <!-- Carrossel de Imagens -->
    <div class="s-produto__carrossel">
      <div class="s-produto__carrossel-itens">
        {% if produto.imagens.all %}
          {% for foto in produto.imagens.all %}
            <div class="s-produto__carrossel-img">
              <img
                src="{{ foto.imagem.url }}"
                alt="{{ produto.nome }} – foto {{ forloop.counter }}"
              />
            </div>
          {% endfor %}
        {% else %}
          <div class="s-produto__carrossel-img">
            <img
              src="{{ produto.imagem.url }}"
              alt="{{ produto.nome }}"
            />
          </div>
        {% endif %}
      </div>

      <div class="s-produto__carrossel-botoes">
        {% if produto.imagens.all %}
          {% for foto in produto.imagens.all %}
            <div
              class="s-produto__carrossel-botao {% if forloop.first %}s-produto__carrossel-botao--selecionado{% endif %}"
              data-index="{{ forloop.counter0 }}"
            ></div>
          {% endfor %}
        {% else %}
          <div class="s-produto__carrossel-botao s-produto__carrossel-botao--selecionado"></div>
        {% endif %}
      </div>
    </div>

    <!-- Informações do Produto -->
    <div class="s-produto__informacoes">
      <div class="s-produto__breadcrumbs">
        <span><a href="{% url 'loja' %}">Loja</a></span>
        <span>
          <a href="{% url 'loja' produto.categoria.slug %}">
            {{ produto.categoria.nome }}
          </a>
        </span>
        <span>
          <a href="{% url 'loja_subcategoria' produto.categoria.slug produto.subcategoria.slug %}">
            {{ produto.subcategoria.nome }}
          </a>
        </span>
        <span><p>{{ produto.nome }}</p></span>
      </div>

      <div class="s-produto__infos">
        <h1 class="s-produto__titulo">{{ produto.nome }}</h1>
        <p class="s-produto__preco">R$ {{ produto.preco }}</p>
        {% if tem_estoque %}
          <strong>Selecione a cor:</strong>
          {% if cor_selecionada %}
            <form method="POST" action="{% url 'adicionar_carrinho' produto.id %}">
              {% csrf_token %}
              <div class="s-produto__cor">
                <p class="s-produto__cor-nome">Cor: <span>{{ cor_selecionada }}</span></p>
                <div class="s-produto__cores">
                  {% for cor in cores %}
                    <a
                      href="{% url 'ver_produto' produto.id cor.id %}"
                      class="s-produto__cores-item"
                      style="background-color: {{ cor.codigo }}"
                    ></a>
                  {% endfor %}
                </div>
              </div>
              <input type="hidden" name="cor" value="{{ id_cor }}">
              <button type="submit" class="s-produto__adicicionar">Adicionar ao carrinho</button>
            </form>

            <!-- Campo de cálculo de frete -->
            <div id="frete-box" style="margin-top: 2rem;">
              <label for="cep">Calcular frete:</label>
              <input
                type="text"
                id="cep"
                name="cep"
                placeholder="Digite o CEP"
                maxlength="9"
                style="padding: 0.5rem; width: 150px; margin-right: 1rem;"
              />
              <button
                type="button"
                onclick="calcularFrete()"
                style="padding: 0.5rem 1rem; cursor: pointer;"
              >
                Calcular
              </button>
              <div id="resultado-frete" style="margin-top: 1rem;"></div>
            </div>

            <script>
              function calcularFrete() {
                const cep = document.getElementById("cep").value;
                const resultado = document.getElementById("resultado-frete");
                if (!cep) {
                  resultado.innerHTML = "<p>Digite um CEP válido.</p>";
                  return;
                }

                resultado.innerHTML = "<p>Calculando frete...</p>";

                fetch("{% url 'calcular_frete' %}?cep=" + cep)
                  .then(response => response.json())
                  .then(data => {
                    if (data.erro) {
                      resultado.innerHTML = `<p style="color: red;">${data.erro}</p>`;
                    } else {
                      let texto = "";
                      if (data.frete_fixo) {
                        texto += `<p><strong>Frete Fixo (Uberlândia):</strong> R$ ${data.frete_fixo}</p>`;
                      }
                      texto += `<p><strong>PAC:</strong> R$ ${data.pac}</p>`;
                      texto += `<p><strong>SEDEX:</strong> R$ ${data.sedex}</p>`;
                      resultado.innerHTML = texto;
                    }
                  })
                  .catch(() => {
                    resultado.innerHTML = "<p style='color: red;'>Erro ao calcular frete.</p>";
                  });
              }
            </script>

          {% else %}
            <div class="s-produto__cores">
              {% for cor in cores %}
                <a
                  href="{% url 'ver_produto' produto.id cor.id %}"
                  class="s-produto__cores-item"
                  style="background-color: {{ cor.codigo }}"
                ></a>
              {% endfor %}
            </div>
          {% endif %}
        {% else %}
          <h3>Item fora de estoque!</h3>
        {% endif %}

        <div class="s-produto__descricao">
          <p class="s-produto__descricao-titulo">Descrição do produto</p>
          <div class="s-produto__descricao-textos">
            <p>{{ produto.descricao }}</p>
            <p>
              CÓDIGO DO PRODUTO<br/>
              Ref: <span>{{ produto.referencia }}</span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  {% if similares %}
    <section class="similares">
      <h2 class="similares__titulo">
        Gostou desse produto? Veja itens similares
      </h2>
      <div class="similares__container">
        {% for similar in similares %}
          <a href="{% url 'ver_produto' similar.id %}" class="produto">
            <div class="produto__imagem">
              {% with similar.imagens.all.0 as foto_principal %}
                {% if foto_principal %}
                  <img
                    src="{{ foto_principal.imagem.url }}"
                    alt="{{ similar.nome }}"
                  />
                {% else %}
                  <img
                    src="{{ similar.imagem.url }}"
                    alt="{{ similar.nome }}"
                  />
                {% endif %}
              {% endwith %}
            </div>
            <div class="produto__textos">
              <p class="produto__titulo">{{ similar.nome }}</p>
              <div class="produto__preco">
                <p class="produto__avista">R$ {{ similar.preco }}</p>
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}
</main>

{% endblock %}
